document.addEventListener("DOMContentLoaded", () => {
  const isMobile = window.innerWidth < 768;
  const isHomepage = window.location.pathname === "/" || window.location.pathname === "/index.html";
  const hasCategory = !!document.querySelector(".post-box__category");

  function initMoeVideo(elementId, deviceMode) {
    if (typeof addContentRoll === 'function') {
      addContentRoll({
        element: `#${elementId}`,
        width: '100%',
        placement: 10444,
        promo: true,
        advertCount: 50,
        slot: 'page',
        sound: 'onclick',
        deviceMode: deviceMode,
        background: 'none',
        fly: {
          mode: 'always',
          animation: 'fly',
          width: 450,
          closeSecOffset: 10,
          position: 'bottom-right',
          indent: { left: 0, right: 0, top: 0, bottom: 0 },
          positionMobile: 'bottom',
        },
      });
    }
  }

  function loadMoeScript(callback) {
    if (!document.querySelector('script[src="https://cdn1.moe.video/p/cr.js"]')) {
      const script = document.createElement('script');
      script.src = 'https://cdn1.moe.video/p/cr.js';
      script.onload = callback;
      document.body.appendChild(script);
    } else {
      callback();
    }
  }

  // Глобальная функция для вызова MoeVideo на мобилке
  window.showMobileMoeVideo = () => {
    let mobContainer = document.getElementById('mvcontentroll_mob');
    if (!mobContainer) {
      mobContainer = document.createElement('div');
      mobContainer.id = 'mvcontentroll_mob';
      document.body.appendChild(mobContainer);
    }
    initMoeVideo('mvcontentroll_mob', 'mobile');
  };

  // MoeVideo на десктопе — если не главная и нет категории
  if (!isMobile && !isHomepage && !hasCategory) {
    const desktopContainer = document.getElementById('mvcontentroll') || document.createElement('div');
    desktopContainer.id = 'mvcontentroll';
    document.body.appendChild(desktopContainer);

    loadMoeScript(() => initMoeVideo('mvcontentroll', 'desktop'));
  }

  // Яндекс реклама на мобилке
  if (isMobile) {
    window.yaContextCb = window.yaContextCb || [];

    // Контейнер для floorAd
    const floorAdContainer = document.createElement('div');
    floorAdContainer.id = 'yandex_rtb_R-A-5924865-2';
    document.body.appendChild(floorAdContainer);

    // Показываем floorAd с коллбэком для запуска MoeVideo
    window.yaContextCb.push(() => {
      Ya.Context.AdvManager.render({
        blockId: 'R-A-5924865-2',
        type: 'floorAd',
        platform: 'touch',
        renderTo: 'yandex_rtb_R-A-5924865-2',
        onClose: () => {
          window.showMobileMoeVideo();
        },
      }, () => {
        // Подстраховка: если onClose не сработал
        window.showMobileMoeVideo();
      });
    });

    // Показываем fullscreen рекламу без коллбэков
    window.yaContextCb.push(() => {
      Ya.Context.AdvManager.render({
        blockId: 'R-A-5924865-3',
        type: 'fullscreen',
        platform: 'touch'
      });
    });
  }
});
